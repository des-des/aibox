<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>d3</title>
    <style>
      body {
        background-color: black;
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
    </div>
    <div class="input">
      <input />
      <button>go</button>
    </div>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script>
      var makeId = (function createIdMaker(idStartPoint) {
        var id = idStartPoint;
        return function idMaker() {
          id += 1;
          return id;
        };
      })(0);

      var create = {
        adder: function(key, toAdd) {
          var adder = function(state) {
            state[key] += toAdd;
          }
          adder.toString = function() {
            return toAdd + ' added to ' + key;
          }
          return adder;
        },
        logger: function(key) {
          var logger = function(state) {
            console.log(state[key]);
          }
          logger.toString = function() {
            return key + ' logged';
          }
          return logger;
        },
        initialiser: function(key, value) {
          var initialiser = function(state) {
            state[key] = value;
          }
          initialiser.toString = function() {
            return key + ' initialised to ' + value;
          }
          return initialiser;
        },
        decide: function(key, op, value) {
          var decide = function(state) {
            switch (op) {
              case '>':
                return state[key] > value;
              case '>=':
                return state[key] >= value;
              case '<':
                return state[key] < value;
              case '<=':
                return state[key] <= value;
              case '===':
                return state[key] === value;
              default:
                console.log('fail in if statement!');
            }
          }
          decide.toString = function() {
            return 'checking ' + key + ' ' + op + ' ' + value;
          }
          return decide;
        }
      }

      var sampleData2 = [
        [
          {
            id: makeId(),
            next: [2],
            type: 'function',
            operation: create.adder('x', 1)
          }
        ],
        [
          {
            id: makeId(),
            next: [3, 4],
            type: 'function',
            operation: create.decide('x', '>', 0)
          }
        ],
        [
          {
            id: makeId(),
            next: [5],
            type: 'function',
            operation: create.adder('x', 10)
          },
          {
            id: makeId(),
            next: [6, 7],
            type: 'function',
            operation: create.decide('x', '>', 10)
          }
        ],
        [
          {
            id: makeId(),
            next: [8],
            type: 'function',
            operation: create.adder('x', 10)
          },
          {
            id: makeId(),
            next: [8],
            type: 'function',
            operation: create.adder('x', -1)
          },
          {
            id: makeId(),
            next: [8],
            type: 'function',
            operation: create.adder('x', 5)
          }
        ],
        [
          {
            id: makeId(),
            next: [9],
            type: 'function',
            operation: create.adder('x', 1)
          }
        ],
        [
          {
            id: makeId(),
            type: 'end',
            operation: create.logger('x')
          }
        ]
      ];

      var state = {}
      var execute = function(node, logicData) {
        if (node.operation.hasOwnProperty('toString')) {
          console.log(node.operation.toString());
        }
        var result = node.operation(state);
        if (!node.next) {
          return ;
        }
        execute(
          getNodeFromLogicData(node.next[result ? 1 : 0], logicData),
          logicData
        );
      }

      var getNodeFromLogicData = function(id, data) {
        return data.filter(function(logicLayer) {
          return logicLayer.reduce(function(found, node) {
            if (node.id === id) {
              found = true;
            }
            return found;
          }, false)
        })[0].filter(function(node) {
          return node.id === id;
        })[0];
      };

      var inputDiv = document.getElementsByClassName('input')[0];
      var input = inputDiv.getElementsByTagName('input')[0];
      var button = inputDiv.getElementsByTagName('button')[0];

      button.addEventListener('click', function() {
        var inputData = parseInt(input.value, 10);
        state = {
          x: inputData
        };
        execute(sampleData2[0][0], sampleData2);
      })

      // execute(sampleData2[0][0], sampleData2);

      var width = 800;

      var getNodesAndLinksFromNodeLevel = function(nodeLevel, nodeLevelDepth) {
        var nodeLevelWidth = nodeLevel.length;
        return nodeLevel.reduce(function(levelRenderData, node, nodeNumber) {
          levelRenderData.nodes.push({
            x: ((nodeNumber+1)/(nodeLevelWidth+1))*width,
            y: (nodeLevelDepth)*100 + 10,
            id: node.id,
            data: node
          });
          if (node && node.next) {
            node.next.forEach(function(link) {
              levelRenderData.links.push([node.id, link]);
            });
          }
          return levelRenderData;
        }, {
          nodes: [],
          links: []
        });
      }

      var createRenderData = function(logicData) {
        return logicData.reduce(function(renderData, nodeLevel, nodeLevelDepth) {
          var levelRenderData =
            getNodesAndLinksFromNodeLevel(nodeLevel, nodeLevelDepth)
          renderData.nodes = renderData.nodes.concat(levelRenderData.nodes);
          renderData.links = renderData.links.concat(levelRenderData.links);
          return renderData;
        }, {
          nodes: [],
          links: []
        });
      }
      var out = createRenderData(sampleData2);

      var getNode = function(id) {
        return out.nodes.filter(function(node) {
          return node.id === id;
        })[0];
      };


      var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", 600)
        .call(d3.behavior.zoom().on("zoom", zoom));

      function zoom() {
        console.log("zooming");
      // d3.event.transform(x); // TODO d3.behavior.zoom should support extents
      // draw();
    }


      svg.selectAll('text')
        .data(out.nodes)
        .enter()
        .append('text')
        .attr("x", function(d) { return d.x+10; })
        .attr("y", function(d) { return d.y+5; })
        .text( function (d) { return d.data.operation.toString(); })
        .attr("font-family", "Courier")
        .attr("font-size", "12px")
        .attr("fill", "white");

      var diagonal = d3.svg.diagonal()
        .source(function(d) {
          return {"x":getNode(d[0]).x, "y":getNode(d[0]).y};
        })
        .target(function(d) {
          return {"x":getNode(d[1]).x, "y":getNode(d[1]).y};
        })
        .projection(function(d) {
          // console.log(d);
          return [d.x, d.y];
        });


      svg.selectAll('line')
        .data(out.links)
        .enter()
        .append('path')
        // .attr('x1', function(d) {return getNode(d[0]).x ;})
        // .attr('y1', function(d) {return getNode(d[0]).y ;})
        // .attr('x2', function(d) {
        //   return getNode(d[1]).x ;})
        // .attr('y2', function(d) {return getNode(d[1]).y ;})
        .attr("stroke-width", 2)
        .attr("stroke", "white")
        .attr('d', diagonal);

      svg.selectAll('circle')
        .data(out.nodes)
        .enter()
        .append('circle')
        .attr('r', 5)
        .attr('cx', function(d) {return d.x ;})
        .attr('cy', function(d) {return d.y ;})
        .attr("fill", "white");

    </script>
  </body>
</html>
